"use strict";(self.webpackChunkgo_micro=self.webpackChunkgo_micro||[]).push([[6492],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},m="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=c(n),h=r,u=m["".concat(l,".").concat(h)]||m[h]||p[h]||o;return n?a.createElement(u,i(i({ref:t},d),{},{components:n})):a.createElement(u,i({ref:t},d))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},6717:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const o={title:"Golang microservice framework (Go-Micro) implements SSE service",description:"Golang microservice framework (Go-Micro) implements SSE service",tags:["go","golang","microservice","go-micro","sse"],hide_table_of_contents:!1},i=void 0,s={permalink:"/2023/08/24/go-micro-implements-sse-service",source:"@site/blog/2023-08-24-go-micro-implements-sse-service.md",title:"Golang microservice framework (Go-Micro) implements SSE service",description:"Golang microservice framework (Go-Micro) implements SSE service",date:"2023-08-24T00:00:00.000Z",formattedDate:"August 24, 2023",tags:[{label:"go",permalink:"/tags/go"},{label:"golang",permalink:"/tags/golang"},{label:"microservice",permalink:"/tags/microservice"},{label:"go-micro",permalink:"/tags/go-micro"},{label:"sse",permalink:"/tags/sse"}],readingTime:5.49,hasTruncateMarker:!0,authors:[],frontMatter:{title:"Golang microservice framework (Go-Micro) implements SSE service",description:"Golang microservice framework (Go-Micro) implements SSE service",tags:["go","golang","microservice","go-micro","sse"],hide_table_of_contents:!1},nextItem:{title:"The interface and inheritance of Golang",permalink:"/2023/05/25/the-interface-and-inheritance-of-golang"}},l={authorsImageUrls:[]},c=[{value:"Overview",id:"overview",level:2},{value:"What is SSE?",id:"what-is-sse",level:3},{value:"Protocol description",id:"protocol-description",level:3},{value:"Data format",id:"data-format",level:4},{value:"Data field",id:"data-field",level:4},{value:"ID field",id:"id-field",level:4},{value:"Event field",id:"event-field",level:4},{value:"Retry field",id:"retry-field",level:4},{value:"Go-Micro server",id:"go-micro-server",level:3},{value:"Javascript client",id:"javascript-client",level:3},{value:"References",id:"references",level:3}],d={toc:c},m="wrapper";function p(e){let{components:t,...n}=e;return(0,r.kt)(m,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"I also only recently learned about SSE.\nI asked people around me and found that there are not many people who know it."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"How did I know about SSE?"),"\nI looked at OpenAI's API and there is a Stream mode, which is implemented using SSE.\nTo put it bluntly, this is an HTTP long connection protocol that continuously sends data to the front end through the\nserver.\nIn the case of unstable network, it is better than WebSocket."),(0,r.kt)("h3",{id:"what-is-sse"},"What is SSE?"),(0,r.kt)("p",null,"Server-Sent Events (SSE for short)"),(0,r.kt)("p",null,"The truth is, the HTTP protocol cannot enable the server to actively push information.\nHowever, there is a workaround where the server declares to the client that the next thing to send is streaming."),(0,r.kt)("p",null,"That means, what is sent is not a one-time data packet, but a data stream which will be sent continuously.\nAt this time, the client will not close the connection, but will always wait for the new data stream sent by the server.\nAnd you can see from the Video Playback is an example of this.\nEssentially, this kind of communication is to complete a long download in the form of streaming information."),(0,r.kt)("p",null,"SSE is similar to WebSocket, in that it establishes a communication channel between the browser and the client, and then\nthe server pushes information to the browser."),(0,r.kt)("p",null,"Overall, WebSocket is more powerful and flexible. Because it is a full-duplex channel, it can communicate in two\ndirections.\nSSE is a one-way channel, which can only be sent from the server to the browser because streaming information is\nessentially downloading.\nIf the browser sends information to the server, it becomes another HTTP request."),(0,r.kt)("p",null,"However, SSE also has its own advantages:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"SSE uses the HTTP protocol, which is supported by existing server software. ",(0,r.kt)("em",{parentName:"li"},"WebSocket is a separate protocol.")),(0,r.kt)("li",{parentName:"ul"},"SSE is lightweight and easy to use, ",(0,r.kt)("em",{parentName:"li"},"but the WebSocket protocol is relatively complex.")),(0,r.kt)("li",{parentName:"ul"},"SSE supports disconnection, and reconnection by default. ",(0,r.kt)("em",{parentName:"li"},"And WebSocket needs to implement it by itself.")),(0,r.kt)("li",{parentName:"ul"},"SSE is only used to transmit text and binary data, and it needs to be encoded before transmission. ",(0,r.kt)("em",{parentName:"li"},"WebSocket supports\nthe transmission of binary data by default.")),(0,r.kt)("li",{parentName:"ul"},"SSE also supports customizing the message types sent.")),(0,r.kt)("p",null,"Therefore, both have their own characteristics and are suitable for different occasions."),(0,r.kt)("h3",{id:"protocol-description"},"Protocol description"),(0,r.kt)("h4",{id:"data-format"},"Data format"),(0,r.kt)("p",null,"The SSE data sent by the server to the browser must be UTF-8 encoded text with the following HTTP header information."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Content-Type: text/event-stream\nCache-Control: no-cache\nConnection: keep-alive\n")),(0,r.kt)("p",null,"Among the above three lines, the ",(0,r.kt)("inlineCode",{parentName:"p"},"Content-Type")," of the first line must specify the MIME type as ",(0,r.kt)("inlineCode",{parentName:"p"},"event-stream"),"."),(0,r.kt)("p",null,"The information sent each time is composed of several messages, and each ",(0,r.kt)("inlineCode",{parentName:"p"},"message")," is separated by ",(0,r.kt)("inlineCode",{parentName:"p"},"\\n\\n"),".\nEach message is composed of several lines, and each line is in the following format:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"[field]: value\\n\n")),(0,r.kt)("p",null,"The above ",(0,r.kt)("inlineCode",{parentName:"p"},"field")," can take four values: ",(0,r.kt)("strong",{parentName:"p"},"data"),", ",(0,r.kt)("strong",{parentName:"p"},"id"),", ",(0,r.kt)("strong",{parentName:"p"},"event"),", ",(0,r.kt)("strong",{parentName:"p"},"retry")),(0,r.kt)("p",null,"In addition, there can be lines beginning with a colon, indicating comments. Normally, the server will send a note to\nthe browser every so often, keeping the connection uninterrupted."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},": This is a comment\\n\\n\n")),(0,r.kt)("p",null,"Below is an example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},": This is a demo stream\\n\\n\n\ndata: some demo text\\n\\n\n\ndata: another demo message\\n\ndata: with two lines \\n\\n\n")),(0,r.kt)("h4",{id:"data-field"},"Data field"),(0,r.kt)("p",null,"The data content is represented by the ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," field.\nIf the data is too long, it can be divided into multiple lines.\nThe last line ends with ",(0,r.kt)("inlineCode",{parentName:"p"},"\\n\\n"),", and the previous lines end with ",(0,r.kt)("inlineCode",{parentName:"p"},"\\n"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"data:  demo message\\n\\n\n\ndata: begin demo message\\n\ndata: continue demo message\\n\ndata: end demo message\\n\\n\n")),(0,r.kt)("p",null,"Here is an example of sending JSON data:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'data: {\\n\ndata: "foo": "bar",\\n\ndata: "baz", 555\\n\ndata: }\\n\\n\n')),(0,r.kt)("h4",{id:"id-field"},"ID field"),(0,r.kt)("p",null,"The data identifier is represented by the ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," field, which is equivalent to the serial number of each piece of data."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"id: msg1\\n\ndata: demo message\\n\\n\n")),(0,r.kt)("p",null,"The browser reads this value and stores it with the ",(0,r.kt)("inlineCode",{parentName:"p"},"lastEventId")," property.\nOnce the connection is disconnected, the browser will send an HTTP header containing a special ",(0,r.kt)("inlineCode",{parentName:"p"},"Last-Event-ID")," header\ninformation, and send this value back to help the server re-establish the connection.\nTherefore, this header can be viewed as a synchronization mechanism."),(0,r.kt)("h4",{id:"event-field"},"Event field"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"event")," field indicates a custom event type, and the default is a ",(0,r.kt)("inlineCode",{parentName:"p"},"message")," event. The browser can listen to this\nevent with ",(0,r.kt)("inlineCode",{parentName:"p"},"addEventListener()"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"event: foo\\n\ndata: a foo event\\n\\n\n\ndata: an unnamed event or a message event\\n\\n\n\nevent: bar\\n\ndata: a bar event\\n\\n\n")),(0,r.kt)("p",null,"The above code creates three messages. The name of the first item is ",(0,r.kt)("inlineCode",{parentName:"p"},"foo"),", which triggers the browser's ",(0,r.kt)("inlineCode",{parentName:"p"},"foo event"),".\nThe second item is unnamed, indicating the default type, and triggers the browser's ",(0,r.kt)("inlineCode",{parentName:"p"},"message event"),".\nThe third item is ",(0,r.kt)("inlineCode",{parentName:"p"},"bar"),", which triggers the browser's ",(0,r.kt)("inlineCode",{parentName:"p"},"bar event"),"."),(0,r.kt)("p",null,"Here's other examples:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'event: userconnect\ndata: {"username": "Tom", "time": "02:33:48"}\n\nevent: usermessage\ndata: {"username": "Tom", "time": "02:34:11", "text": "Hi everyone."}\n\nevent: userdisconnect\ndata: {"username": "Tom", "time": "02:34:23"}\n\nevent: usermessage\ndata: {"username": "Jerry", "time": "02:34:36", "text": "Bye, Tom."}\n')),(0,r.kt)("h4",{id:"retry-field"},"Retry field"),(0,r.kt)("p",null,"The server can use this ",(0,r.kt)("inlineCode",{parentName:"p"},"retry")," field to specify the time interval for the browser to re-initiate the connection."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"retry: 10000\\n\n")),(0,r.kt)("p",null,"Two situations will cause the browser to re-initiate the connection:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"One is that the time interval expires."),(0,r.kt)("li",{parentName:"ul"},"The other is a connection error due to network error and other reasons.")),(0,r.kt)("h3",{id:"go-micro-server"},"Go-Micro server"),(0,r.kt)("p",null,"Firstly install the library:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"go get -u github.com/devexps/go-micro/transport/sse/v2\n")),(0,r.kt)("p",null,"Then implement a simple server:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'interrupt := make(chan os.Signal, 1)\nsignal.Notify(interrupt, syscall.SIGHUP, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT)\n\nctx := context.Background()\n\ns := NewServer(\nWithAddress(":8080"),\n)\ndefer s.Stop(ctx)\n\ns.HandleServeHTTP("/events")\n\ns.CreateStream("demo")\n\ngo func () {\ns.Start(ctx)\n}()\n\ns.Publish("demo", &Event{Data: []byte("message")})\n\n<-interrupt\n')),(0,r.kt)("h3",{id:"javascript-client"},"Javascript client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <title>SSE Client</title>\n    <meta charset='utf-8'>\n    <meta http-equiv='X-UA-Compatible' content='IE=edge'>\n    <meta name='viewport' content='width=device-width, initial-scale=1'>\n</head>\n<body>\n<div>\n    <ul id=\"messages\">\n    </ul>\n</div>\n\n<script>\n    if (window.EventSource == null) {\n        alert('The browser does not support Server-Sent Events');\n    }\n\n    const eventSource = new EventSource(\"http://localhost:8080/events?stream=demo\")\n\n    // Fired when the event source connection fails to open.\n    eventSource.onerror = function (error) {\n        console.log('connection state: ' + eventSource.readyState + ', error: ' + error);\n    };\n\n    // Fired when a connection to the event source is opened.\n    eventSource.onopen = function () {\n        console.log('connection is established');\n    };\n\n    // Fired when data is received from the event source.\n    eventSource.onmessage = (event) => {\n        console.log('id: ' + event.lastEventId + ', data: ' + event.data);\n        //console.log(JSON.parse(event.data))\n        const ul = document.getElementById(\"messages\");\n        const li = document.createElement(\"li\");\n        li.appendChild(document.createTextNode(`${event.data}`));\n        li.setAttribute(\"id\", `msg-${event.lastEventId}`);\n        ul.appendChild(li);\n    }\n<\/script>\n</body>\n</html>\n")),(0,r.kt)("p",null,"Code repository: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/devexps/go-sse"},"https://github.com/devexps/go-sse")),(0,r.kt)("h3",{id:"references"},"References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Server-sent_events"},"Server-sent events - Wikipedia")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://dev.to/rafaelgfirmino/golang-and-sse-3l56"},"Golang and Server-Sent Events (SSE)"))))}p.isMDXComponent=!0}}]);